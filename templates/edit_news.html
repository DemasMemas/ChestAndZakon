{% extends "base.html" %}

{% block title %}Редактировать новость{% endblock %}

{% block content %}
<h1>Редактировать новость</h1>

<form method="POST" enctype="multipart/form-data" id="news-form">
    <div>
        <label for="title">Заголовок:</label>
        <input type="text" id="title" name="title" value="{{ news.title }}" required style="width: 100%; padding: 8px; margin: 5px 0;">
    </div>
    
    <div>
        <label for="content">Текст новости:</label>
        <textarea id="content" name="content" rows="10" required style="width: 100%; padding: 8px; margin: 5px 0;">{{ news.content }}</textarea>
    </div>
    
    <!-- Существующие изображения -->
    {% if news.images %}
    <div style="margin: 20px 0;">
        <h3>Текущие изображения</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
            {% for image in news.images %}
            <div style="position: relative; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                <img src="{{ url_for('static', filename=image.image_path) }}" 
                     alt="Изображение {{ loop.index }}" 
                     style="width: 100%; height: 150px; object-fit: cover;">
                <div style="text-align: center; margin-top: 5px;">
                    <a href="{{ url_for('delete_news_image', image_id=image.id) }}" 
                       onclick="return confirm('Удалить это изображение?')"
                       style="color: #ff4444; font-size: 0.9em;">Удалить</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Новые изображения (необязательные) -->
    <div style="margin: 20px 0;">
        <h3>Добавить новые изображения (необязательно)</h3>
        <div id="images-container">
            <div class="image-field">
                <input type="file" name="images" accept="image/*">
                <button type="button" class="remove-image" onclick="removeImageField(this)" style="margin-left: 10px; color: red;">✕</button>
            </div>
        </div>
        <button type="button" onclick="addImageField()" style="margin-top: 10px;">+ Добавить еще изображение</button>
    </div>

    <!-- Существующие видео -->
    {% if news.videos %}
    <div style="margin: 20px 0;">
        <h3>Текущие видео</h3>
        <div style="display: grid; gap: 15px;">
            {% for video in news.videos %}
            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                <h4>{{ video.title }}</h4>
                <p><strong>Тип:</strong>
                    {% if video.video_type == 'vk' %}VK Видео
                    {% elif video.video_type == 'rutube' %}RuTube
                    {% elif video.video_type == 'uploaded' %}Загруженное видео
                    {% else %}{{ video.video_type }}{% endif %}
                </p>
                {% if video.video_url %}
                <p><strong>URL:</strong> {{ video.video_url }}</p>
                {% endif %}
                <div style="text-align: right;">
                    <a href="{{ url_for('delete_news_video', video_id=video.id) }}"
                       onclick="return confirm('Удалить это видео?')"
                       style="color: #ff4444; font-size: 0.9em;">Удалить видео</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Новые видео (необязательные) -->
    <div style="margin: 20px 0;">
        <h3>Добавить новые видео (необязательно)</h3>
        <div id="videos-container">
            <div class="video-field">
                <select name="video_types" onchange="toggleVideoInput(this)">
                    <option value="vk">VK Видео</option>
                    <option value="rutube">RuTube</option>
                    <option value="uploaded">Загрузить видеофайл</option>
                </select>
                <input type="url" name="video_urls" placeholder="URL видео (VK или RuTube)" style="margin-left: 10px; width: 300px;" class="video-url">
                <input type="file" name="video_files" accept="video/*" style="margin-left: 10px; width: 300px; display: none;" class="video-file">
                <input type="text" name="video_titles" placeholder="Название видео (необязательно)" style="margin-left: 10px; width: 200px;">
                <button type="button" class="remove-video" onclick="removeVideoField(this)" style="margin-left: 10px; color: red;">✕</button>
            </div>
        </div>
        <button type="button" onclick="addVideoField()" style="margin-top: 10px;">+ Добавить еще видео</button>
    </div>

    <div style="margin-top: 20px;">
        <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none;">Сохранить изменения</button>
        <a href="{{ url_for('news_detail', news_id=news.id) }}" style="margin-left: 15px; padding: 10px 20px; background: #6c757d; color: white; text-decoration: none;">Отмена</a>
    </div>
</form>

<script>
// Функции для динамического добавления полей изображений
function addImageField() {
    const container = document.getElementById('images-container');
    const newField = document.createElement('div');
    newField.className = 'image-field';
    newField.innerHTML = `
        <input type="file" name="images" accept="image/*">
        <button type="button" class="remove-image" onclick="removeImageField(this)" style="margin-left: 10px; color: red;">✕</button>
    `;
    container.appendChild(newField);
}

function removeImageField(button) {
    const fields = document.querySelectorAll('.image-field');
    if (fields.length > 1) {
        button.parentElement.remove();
    }
}

// Функции для динамического добавления полей видео
function addVideoField() {
    const container = document.getElementById('videos-container');
    const newField = document.createElement('div');
    newField.className = 'video-field';
    newField.innerHTML = `
        <select name="video_types" onchange="toggleVideoInput(this)">
            <option value="vk">VK Видео</option>
            <option value="rutube">RuTube</option>
            <option value="uploaded">Загрузить видеофайл</option>
        </select>
        <input type="url" name="video_urls" placeholder="URL видео (VK или RuTube)" style="margin-left: 10px; width: 300px;" class="video-url">
        <input type="file" name="video_files" accept="video/*" style="margin-left: 10px; width: 300px; display: none;" class="video-file">
        <input type="text" name="video_titles" placeholder="Название видео" style="margin-left: 10px; width: 200px;">
        <button type="button" class="remove-video" onclick="removeVideoField(this)" style="margin-left: 10px; color: red;">✕</button>
    `;
    container.appendChild(newField);
}

function removeVideoField(button) {
    const fields = document.querySelectorAll('.video-field');
    if (fields.length > 1) {
        button.parentElement.remove();
    }
}

function toggleVideoInput(select) {
    const field = select.closest('.video-field');
    const urlInput = field.querySelector('.video-url');
    const fileInput = field.querySelector('.video-file');

    if (select.value === 'uploaded') {
        urlInput.style.display = 'none';
        fileInput.style.display = 'inline-block';
        // Убираем required для необязательных полей
        fileInput.removeAttribute('required');
        urlInput.removeAttribute('required');
    } else {
        urlInput.style.display = 'inline-block';
        fileInput.style.display = 'none';
        // Убираем required для необязательных полей
        urlInput.removeAttribute('required');
        fileInput.removeAttribute('required');
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('select[name="video_types"]').forEach(toggleVideoInput);
});
</script>

<a href="{{ url_for('admin_panel') }}">← Назад в админ-панель</a>
{% endblock %}
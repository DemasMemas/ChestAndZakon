{% extends "base.html" %}

{% block title %}{{ news_item.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Кнопки управления для админов -->
    {% if current_user.is_authenticated and current_user.is_admin %}
    <div class="alert alert-admin d-flex justify-content-between align-items-center">
        <span>Управление новостью</span>
        <div>
            <a href="{{ url_for('edit_news', news_id=news_item.id) }}" class="btn btn-warning btn-sm">
                <i class="bi bi-pencil"></i> Редактировать
            </a>
            <a href="{{ url_for('delete_news', news_id=news_item.id) }}"
               class="btn btn-danger btn-sm"
               onclick="return confirm('Удалить эту новость? Все комментарии и медиафайлы также будут удалены.')">
                <i class="bi bi-trash"></i> Удалить
            </a>
        </div>
    </div>
    {% endif %}

    <article class="mb-5">
        <header class="mb-4">
            <h1 class="h2">{{ news_item.title }}</h1>
            <div class="text-muted">
                <i class="bi bi-calendar"></i> Опубликовано: {{ news_item.created_at.strftime('%d.%m.%Y в %H:%M') }}
            </div>
        </header>

        <!-- Галерея изображений -->
        {% if news_item.images %}
        <section class="mb-4">
            <h3 class="h4">Галерея ({{ news_item.images|length }} фото)</h3>
            <div class="row g-3">
                {% for image in news_item.images %}
                <div class="col-md-4 col-lg-3">
                    {% set filename = image.image_path.split('/')[-1] %}
                    <img src="{{ url_for('uploaded_files', filename=filename) }}"
                         alt="Изображение {{ loop.index }}"
                         class="img-thumbnail"
                         style="width: 100%; height: 200px; object-fit: contain; background: #f8f9fa; cursor: pointer; padding: 5px;"
                         onclick="openImageModal('{{ url_for('uploaded_files', filename=filename) }}')">
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- Видео -->
        {% if news_item.videos %}
        <div class="videos-section">
            <h3>Видео</h3>
            {% for video in news_item.videos %}
            <div class="video-item" style="margin: 20px 0;">
                <h4>{{ video.title }}</h4>
                {% if video.video_type == 'vk' and video.video_url %}
                    <!-- Простой iframe для VK -->
                    {% set vk_params = video.video_url|extract_vk_params %}
                    {% if vk_params %}
                    <iframe
                        src="https://vk.com/video_ext.php?{{ vk_params }}"
                        width="800"
                        height="450"
                        frameborder="0"
                        allowfullscreen>
                    </iframe>
                    {% else %}
                    <p>Неверная ссылка VK: {{ video.video_url }}</p>
                    {% endif %}
                {% elif video.video_type == 'rutube' and video.video_url %}
                    <!-- Встраивание RuTube видео -->
                    {% set rutube_id = video.video_url|extract_rutube_video_id %}
                    {% if rutube_id %}
                    <iframe
                        src="https://rutube.ru/play/embed/{{ rutube_id }}"
                        width="800"
                        height="450"
                        frameborder="0"
                        allowfullscreen>
                    </iframe>
                    {% else %}
                    <p>Неверная ссылка RuTube: {{ video.video_url }}</p>
                    {% endif %}
                {% elif video.video_type == 'uploaded' and video.video_path %}
                    <!-- Загруженные видео -->
                    <video controls width="800">
                        <source src="{{ url_for('uploaded_videos', filename=video.video_path.split('/')[-1]) }}" type="video/mp4">
                        Ваш браузер не поддерживает видео.
                    </video>
                {% else %}
                    <p>Не удалось загрузить видео</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Текст новости -->
        <section class="news-content mb-5">
            <div class="bg-light p-4 rounded">
                {{ news_item.content|replace('\n', '<br>')|safe }}
            </div>
        </section>
    </article>

        <!-- Список комментариев -->
    <section class="comments">
        <h3 class="h4 mb-4">Комментарии ({{ comments_pagination.total }})</h3>

        {% if comments %}
            {% for comment in comments %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">{{ comment.author }}</h6>
                        <small class="text-muted">{{ comment.created_at.strftime('%d.%m.%Y в %H:%M') }}</small>
                    </div>
                    <p class="card-text">{{ comment.content }}</p>

                    {% if current_user.is_authenticated and current_user.is_admin %}
                    <div class="mt-2">
                        <a href="{{ url_for('delete_comment', comment_id=comment.id) }}"
                           class="btn btn-danger btn-sm"
                           onclick="return confirm('Удалить этот комментарий?')">
                            <i class="bi bi-trash"></i> Удалить
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            <!-- Пагинация для комментариев -->
            {% if comments_pagination.pages > 1 %}
            <nav aria-label="Comments pagination">
                <ul class="pagination justify-content-center">
                    {% if comments_pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('news_detail', news_id=news_item.id, page=comments_pagination.prev_num) }}">Назад</a>
                    </li>
                    {% endif %}

                    {% for page_num in comments_pagination.iter_pages(left_edge=1, left_current=1, right_current=1, right_edge=1) %}
                        {% if page_num %}
                            {% if page_num != comments_pagination.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('news_detail', news_id=news_item.id, page=page_num) }}">{{ page_num }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if comments_pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('news_detail', news_id=news_item.id, page=comments_pagination.next_num) }}">Вперед</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <div class="alert alert-info text-center">
                <p class="mb-0">Пока нет комментариев. Будьте первым!</p>
            </div>
        {% endif %}
    </section>

    <!-- Форма добавления комментария -->
    <section class="mb-5">
        <div class="card">
            <div class="card-header">
                <h3 class="h5 mb-0">Добавить комментарий</h3>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="author" class="form-label">Ваше имя</label>
                        <input type="text" class="form-control" id="author" name="author" required>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Комментарий</label>
                        <textarea class="form-control" id="content" name="content" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Отправить комментарий</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Навигация -->
    <div class="mt-4">
        <a href="{{ url_for('news') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Все новости
        </a>
    </div>
</div>

<!-- Модальное окно для просмотра изображений -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Просмотр изображения</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="modalImage" src="" alt="" class="img-fluid" style="max-height: 80vh; object-fit: contain;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script>
function openImageModal(imageSrc) {
    // Проверяем, полный ли это URL или относительный путь
    if (!imageSrc.startsWith('http')) {
        // Если относительный путь, добавляем базовый URL
        imageSrc = window.location.origin + imageSrc;
    }

    document.getElementById('modalImage').src = imageSrc;
    var myModal = new bootstrap.Modal(document.getElementById('imageModal'));
    myModal.show();
}
</script>

<style>
.alert-admin {
    background-color: #e2f0ff;
    border: 1px solid #b6d4fe;
    border-radius: 0.375rem;
}

.img-thumbnail {
    transition: transform 0.2s ease-in-out;
    border: 2px solid #dee2e6;
}

.img-thumbnail:hover {
    transform: scale(1.05);
    border-color: #007bff;
}

.video-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    background: #f8f9fa;
}

.video-item iframe {
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
</style>
{% endblock %}